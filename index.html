<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Landslide Warning Map</title>
        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <!-- Leaflet Locate Control CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.css" />
        <!-- Leaflet Search Control CSS -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.css" />
        <!-- Leaflet JS -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <!-- Leaflet Locate Control JS -->
        <script src="https://cdn.jsdelivr.net/npm/leaflet.locatecontrol@0.79.0/dist/L.Control.Locate.min.js"></script>
        <!-- Leaflet Search Control JS -->
        <script src="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.js"></script>
        <style>
            body {
                margin: 0;
                padding: 0;
                font-family: Arial, sans-serif;
            }
            #map {
                height: 80vh;
                width: 100%;
            }
            #controls {
                position: absolute;
                top: 10px;
                right: 10px;
                z-index: 1000;
                background: white;
                padding: 10px;
                border-radius: 5px;
                box-shadow: 0 0 10px rgba(0,0,0,0.5);
            }
            #controls button {
                display: block;
                margin: 5px 0;
                padding: 5px 10px;
                cursor: pointer;
            }
            /* Flashing animations for buffers */
            @keyframes flash-yellow {
                0%, 50% { fill-opacity: 0.3; }
                25%, 75% { fill-opacity: 0.8; }
            }
            @keyframes flash-orange {
                0%, 50% { fill-opacity: 0.3; }
                25%, 75% { fill-opacity: 0.8; }
            }
            @keyframes flash-red {
                0%, 50% { fill-opacity: 0.3; }
                25%, 75% { fill-opacity: 0.8; }
            }
            .flash-yellow {
                animation: flash-yellow 1s infinite;
            }
            .flash-orange {
                animation: flash-orange 1s infinite;
            }
            .flash-red {
                animation: flash-red 1s infinite;
            }
            /* Scrollable popup content */
            .popup-content {
                max-height: 1000px;
                max-width: 800px;
                overflow-y: auto;
                font-size: 12px;
            }
            .popup-table {
                width: 100%;
                border-collapse: collapse;
            }
            .popup-table th, .popup-table td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
                vertical-align: top;
            }
            .popup-table th {
                background-color: teal;
                font-size: 12px;
                color: white;
            }
            .popup-table img {
                max-width: 100%;
                height: auto;
            }
            /* Custom popup styling */
            .leaflet-popup-content-wrapper {
                background-color: white; /* Teal blue */
                color: black; /* Ensure text is visible */
            }
            .leaflet-popup-content {
                margin: 0; /* Remove default margin */
            }
            .popup-content h3, .popup-content h4 {
                color: black; /* Orange */
                margin-top: 0;
            }
            .leaflet-popup-tip {
                background-color: white; /* Match the wrapper */
            }
            /* Custom toggle switch styles for layer control checkboxes */
            .leaflet-control-layers input[type="checkbox"] {
                display: none; /* Hide the default checkbox */
            }

            .leaflet-control-layers label {
                position: relative;
                display: block;
                padding-left: 50px; /* Space for the switch */
                cursor: pointer;
                font-size: 14px;
                line-height: 20px;
            }

            .leaflet-control-layers label::before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                width: 40px;
                height: 20px;
                background: #ccc;
                border-radius: 10px;
                transition: background 0.3s;
            }

            .leaflet-control-layers label::after {
                content: '';
                position: absolute;
                left: 2px;
                top: 2px;
                width: 16px;
                height: 16px;
                background: #fff;
                border-radius: 50%;
                transition: transform 0.3s;
            }

            .leaflet-control-layers input[type="checkbox"]:checked + label::before {
                background: #4CAF50; /* Green when checked */
            }

            .leaflet-control-layers input[type="checkbox"]:checked + label::after {
                transform: translateX(20px); /* Slide the knob */
            }

            /* Optional: Add custom icons/logos next to layer names (using background images) */
            /* Example: Add a data-icon attribute to layers if needed, e.g., data-icon="icon1.png" */
            .leaflet-control-layers label[data-icon]:before {
                background-image: url('path/to/your/icon.png'); /* Replace with actual icon path */
                background-size: 16px 16px;
                background-repeat: no-repeat;
                background-position: center;
                width: 20px;
                height: 20px;
                left: -25px; /* Position icon left of switch */
            }

            /* Custom legend styles */
            .legend {
                background: white;
                border: 2px solid rgba(0,0,0,0.2);
                border-radius: 5px;
                padding: 10px;
                max-height: 300px;
                overflow-y: auto;
            }
            .legend-toggle {
                background: none;
                border: none;
                font-size: 16px;
                cursor: pointer;
                width: 100%;
                text-align: left;
                padding: 0;
                margin-bottom: 10px;
            }
            .legend-content {
                transition: display 0.3s;
            }
            .legend-content.hidden {
                display: none;
            }
            .legend-item {
                display: flex;
                align-items: center;
                margin-bottom: 5px;
            }
            .legend-logo {
                width: 20px;
                height: 20px;
                margin-right: 8px;
                background-size: cover;
            }
            .legend-swatch {
                width: 15px;
                height: 15px;
                border-radius: 50%;
                margin-right: 8px;
                border: 1px solid #000;
            }
            .legend-text {
                font-size: 12px;
            }
            .leaflet-control-reset {
                background-color: white;
                border: 2px solid rgba(0,0,0,0.2);
                border-radius: 4px;
                box-shadow: 0 1px 5px rgba(0,0,0,0.65);
                cursor: pointer;
                padding: 5px;
                font-size: 14px;
            }
            .leaflet-control-reset:hover {
                background-color: #f4f4f4;
            }

            /* Custom header panel styles */
            .header-panel {
                background: rgba(255, 255, 255, 0.9);
                border: 1px solid #ccc;
                border-radius: 5px;
                padding: 10px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                width: 100%;
                max-width: 600px; /* Adjust for responsiveness */
            }
            #header2 {
                padding: 8px 10px;
                gap: 20px;
            }
            #header2 {
                background: linear-gradient(135deg, #1a3b42, #268171);
                text-align: center;
                color: white;
                padding: 10px 20px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                display: flex;
                flex-wrap: wrap;
            }
            #loading-screen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: teal; /* Teal to orange gradient */
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                animation: fadeIn 1s ease-in-out;
            }
            #loading-screen.hidden {
                animation: fadeOut 1s ease-in-out forwards;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes fadeOut {
                from { opacity: 1; }
                to { opacity: 0; visibility: hidden; }
            }
            .logo {
                font-size: 4rem;
                color: #FFA500;
                margin-bottom: 20px;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            }
            .loading-text {
                font-size: 2rem;
                color: white;
                margin-bottom: 30px;
                font-weight: bold;
            }
            .spinner {
                width: 50px;
                height: 50px;
                border: 5px solid #FFA500;
                border-top: 5px solid #008080;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            .progress-container {
                width: 300px;
                height: 20px;
                background: rgba(255, 255, 255, 0.3);
                border-radius: 10px;
                overflow: hidden;
                position: relative;
            }
            .progress-bar {
                height: 100%;
                background: linear-gradient(90deg, #008080, #FFA500);
                width: 0%;
                animation: landslide 10s linear forwards; /* 10-second landslide animation */
            }
            @keyframes landslide {
                0% { width: 0%; }
                100% { width: 100%; }
            }
            #toggle-buffer {
                background-color: #1a3b42;
                border: none;
                color: white;
                padding: 5px 20px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 11px;
                border-radius: 15px;
                transition-duration: 0.4s;
                cursor: pointer;
            }

            #time-controls {
                top: 70px;
                right: 10px;
                flex-direction: column;
            }

            #current-date {
                margin-right: 0;
                margin-bottom: 5px;
            }
            .button {
                background-color: #1a3b42;
                border: none;
                color: white;
                padding: 5px 20px;
                text-align: center;
                text-decoration: none;
                display: inline-block;
                font-size: 11px;
                border-radius: 15px;
                transition-duration: 0.4s;
                cursor: pointer;
            }
            .button1 {border: 2px solid #04AA6D;}
            .button1:hover {
                background-color: #268171;
                color: white;
            }
            .button2 {border: 2px solid #04AA6D;}
            .button2:hover {
                background-color: #268171;
                color: white;
            }
            .button4 {border: 2px solid #04AA6D;}
            .button4:hover {
                background-color: #268171;
                color: white;
            }
            #navbar { background: #f0f0f0; padding: 10px; border-bottom: 1px solid #ccc; }
            #navbar summary { cursor: pointer; font-weight: bold; padding: 10px; background: #e0e0e0; border: 1px solid #ccc; margin-bottom: 10px; }
            #navbar details[open] summary { background: #d0d0d0; }
            button { margin: 5px; padding: 5px 10px; }
            #layerControls label { display: block; margin: 5px 0; }
            #speedControl { margin: 10px 0; display: flex; align-items: center; }
            #speedControl label { margin-right: 10px; }
            #propertiesTable { margin: 10px; border-collapse: collapse; width: 100%; }
            #propertiesTable th, #propertiesTable td { border: 1px solid #ccc; padding: 8px; text-align: left; }
            #propertiesTable th { background-color: #f2f2f2; }
            #propertiesContainer { background: #f9f9f9; padding: 10px; border: 1px solid #ccc; }
            #propertiesContainer summary { cursor: pointer; font-weight: bold; padding: 10px; background: #e0e0e0; border: 1px solid #ccc; }
            #propertiesContainer details[open] summary { background: #d0d0d0; }
            #errorOverride { margin: 10px; padding: 10px; background: #ffe6e6; border: 1px solid #ff9999; display: none; }
        </style>
    </head>
    <body>
        <div id="loading-screen">
            <div class="logo"><img src="https://raw.githubusercontent.com/Gabzrock/LIGTASAGADEWSV3/refs/heads/main/LIGTAS.png" alt="Logo" width="200" height="200" ></div> <!-- Placeholder logo (mountain icon). Replace with <img src="your-logo-url.png" alt="Logo"> -->
            <div class="loading-text">Rainfall-Induced Landslide Early Warning System (RILEWS)</div>
            <div class="spinner"></div>
            <div class="progress-container">
                <div class="progress-bar"></div>
            </div>
        </div>
        <div id="header2">
            LIGTAS-AGAD Rainfall-Induced Landslide Early Warning System (RILEWS) <br>
            <div id="real-time"></div> 
            <button class="button button1" onclick="Homebutton()">Home</button>
            <button class="button button2" onclick="AWSbutton()"> AWS Monitoring</button>
            <button class="button4" id="toggle-buffer">20-KM Warning</button>
        </div>
        <nav id="navbar">
            <details>
                <summary>Map Controls</summary>
                <h5>Group Controls</h5>
                <button id="playBtn">Play</button>
                <button id="pauseBtn">Pause</button>
                <button id="stopBtn">Stop</button>
                <span id="currentGroup">Current Group: 1</span>
                <div id="speedControl">
                    <label for="speedSlider">Speed (seconds per group):</label>
                    <input type="range" id="speedSlider" min="1" max="10" value="5" step="1">
                    <span id="speedValue">5</span>
                </div>
                <h5>Layer Controls</h5>
                <button id="removeAllBtn">Remove All Layers</button>
                <button id="addAllBtn">Add All Layers</button>
                <div id="layerControls"></div>
            </details>
        </nav>
        <div id="map"></div>

        <div id="propertiesContainer">
            <details>
                <summary>Feature Properties Table</summary>
                <table id="propertiesTable">
                    <thead>
                        <tr>
                            <th>Layer</th>
                            <th>Property</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody id="propertiesTableBody">
                        <!-- Rows will be added here dynamically -->
                    </tbody>
                </table>
            </details>
        </div>
        <script>

            // Hide loading screen after 10 seconds
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
            }, 10000); // 10 seconds

            // Real-time clock function
            function updateClock() {
                const now = new Date();
                const dateStr = now.toLocaleDateString('en-PH', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeStr = now.toLocaleTimeString('en-PH');
                document.getElementById('real-time').textContent = `${dateStr} | ${timeStr}`;
            }

            // Update clock immediately and then every second
            updateClock();
            setInterval(updateClock, 1000);


            // Initialize the map centered on the Philippines
            const initialCenter = [12.8797, 121.7740]; // Approximate center of the Philippines
            const initialZoom = 6;
            const map = L.map('map').setView(initialCenter, initialZoom);


            // Define base layers
            var streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            });

            var hybrid = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }).addTo(map); // Set hybrid as default

            var topo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: USGS, Esri, TANA, DeLorme, and NPS'
            });

            // Initialize GeoJSON layer as empty layer group
            var geojsonLayer = L.layerGroup();

            // Add layer control with overlays, positioned at bottom-right to avoid overlap
            var baseLayers = {
                "Streets": streets,
                "Satellite": satellite,
                "Hybrid": hybrid,
                "Topo": topo
            };

            var overlays = {};

            // Add scale bar
            L.control.scale().addTo(map);

            // Add GPS (locate) control
            L.control.locate().addTo(map);

            // Add search bar
            var searchControl = new L.Control.Search({
                url: 'https://nominatim.openstreetmap.org/search?format=json&q={s}',
                jsonpParam: 'json_callback',
                propertyName: 'display_name',
                propertyLoc: ['lat', 'lon'],
                marker: L.circleMarker([0, 0], { radius: 30 }),
                autoCollapse: true,
                autoType: false,
                minLength: 2
            });
            searchControl.on('search:locationfound', function(e) {
                if (e.layer._popup) e.layer.openPopup();
            });
            map.addControl(searchControl);



            // Function to create a GeoJSON layer (now includes description and dot markers)
            function createGeoJSONLayer(name, description, geojsonUrl, styleOptions = {}) {
                const fullName = `${name}: ${description}`;  // Append description to name
                return fetch(geojsonUrl)
                    .then(response => response.json())
                    .then(data => {
                    const layer = L.geoJSON(data, {
                        style: styleOptions,
                        pointToLayer: (feature, latlng) => {
                            return L.circleMarker(latlng, {
                                color: styleOptions.color || 'blue',  // Border color
                                fillColor: styleOptions.color || 'blue',  // Fill color
                                fillOpacity: 0.8,
                                radius: 6  // Size of the dot (adjust as needed)
                            });
                        },
                        onEachFeature: (feature, layer) => {
                            // Generate popup content from all properties
                            let popupContent = '<strong>Attributes:</strong><br>';
                            if (feature.properties) {
                                for (const [key, value] of Object.entries(feature.properties)) {
                                    popupContent += `${key}: ${value}<br>`;
                                }
                            } else {
                                popupContent += 'No attributes available.';
                            }
                            layer.bindPopup(popupContent);
                        }
                    });
                    overlays[fullName] = layer;  // Use full name with description as key
                    return layer;
                })
                    .catch(error => console.error(`Error loading ${name}:`, error));
            }
            // Define logos for each layer (replace with your logo URLs or data URIs)
            const layerLogos = [
                'https://example.com/logo1.png', // Layer 1
                'https://example.com/logo2.png', // Layer 2
                'https://example.com/logo3.png', // Layer 3
                'https://example.com/logo4.png', // Layer 4
                'https://example.com/logo5.png', // Layer 5
                'https://example.com/logo6.png', // Layer 6
                'https://example.com/logo7.png', // Layer 7
                'https://example.com/logo8.png', // Layer 8
                'https://ligtas.uplb.edu.ph/wp-content/uploads/2022/04/3-e1659971771933.png', // Layer 9
                'https://ligtas.uplb.edu.ph/wp-content/uploads/2022/02/SARAI.png',
                'https://ligtas.uplb.edu.ph/wp-content/uploads/2022/10/DOST-ASTI-Logo-RGB-e1722929759841.png' // Layer 10// Layer 10 
            ];

            // Define layer data (name, description, color)
            const layerData = [
                { name: 'PH Boundary', desc: 'Philippine Boundary', color: 'white' },
                { name: 'LIGTAS-LSDB', desc: 'Recorded Landslides', color: 'orange' },
                { name: 'MGB', desc: 'HIGH Rainfall-Induced Landslide Susceptibility', color: 'red' },
                { name: 'MGB', desc: 'MED Rainfall-Induced Landslide Susceptibility', color: 'yellow' },
                { name: 'MGB', desc: 'LOW Rainfall-Induced Landslide Susceptibility', color: 'green' },
                { name: 'CAR Boundary', desc: 'CAR Boundary', color: 'blue' },
                { name: 'Bicol Boundary', desc: 'Bicol Boundary', color: 'purple' },
                { name: 'CALABARZON Boundary', desc: 'CALABARZON Boundary', color: 'brown' },
                { name: 'LIGTAS AWS', desc: 'LIGTAS AWS', color: 'white' },
                { name: 'SARAI AWS', desc: 'SARAI AWS', color: 'white' },
                { name: 'ASTI AWS', desc: 'ASTI AWS', color: 'white' }
            ];

            // Array of layer promises with descriptions (replace URLs and descriptions with your data)
            const layerPromises = [
                createGeoJSONLayer('LIGTAS-LSDB', 'LIGTAS-AGAD Landslide database', 'https://raw.githubusercontent.com/Gabzrock/LIGTAS-AGAD/refs/heads/main/LandslideDB-web.geojson', { color: 'orange', weight: 2 }),
                createGeoJSONLayer('PH boundary', 'Philippine Boundary', 'https://raw.githubusercontent.com/Gabzrock/LIGTAS-AGAD/refs/heads/main/country.0.01.json', { color: 'white', weight: 1 }),
                createGeoJSONLayer('CALABARZON', 'CALABARZON_Boundary', 'file:///C:/LIGTAS-EWS/CALABARZON-web.geojson', { color: 'blue', weight: 2 }),
                createGeoJSONLayer('CAR', 'CAR_Boundary', 'https://raw.githubusercontent.com/Gabzrock/LIGTASAGADEWSV3/refs/heads/main/uCAR-web.geojson', { color: 'blue', weight: 2 }),
                createGeoJSONLayer('MGB-HIGH', 'Rainfall induced-Landslide Susceptibility', 'https://raw.githubusercontent.com/Gabzrock/LIGTASAGADEWSV3/refs/heads/main/uRIL_AWS_High%20Susceptibility.geojson', { color: 'red',fillOpacity:1.3}),
                createGeoJSONLayer('MGB-MED', 'Rainfall induced-Landslide Susceptibility', 'https://raw.githubusercontent.com/Gabzrock/LIGTASAGADEWSV3/refs/heads/main/uRIL_AWS_Moderate_Susceptibility.geojson', { color: 'yellow',fillOpacity:1.3}),
                createGeoJSONLayer('MGB-LOW', 'Rainfall induced-Landslide Susceptibility', 'https://raw.githubusercontent.com/Gabzrock/LIGTASAGADEWSV3/refs/heads/main/uRIL_AWS_Low_Susceptibility.geojson', { color: 'green',fillOpacity:1.3}),
                createGeoJSONLayer('Bicol', 'Bicol_Region', '', { color: 'blue', weight: 2 }),
                createGeoJSONLayer('CReSS_L1', 'CReSS_L1', '', { color: 'orange', weight: 2,fillOpacity:1.3}),
                createGeoJSONLayer('CReSS_L2', 'CReSS_L2', '', { color: 'yellow', weight: 2,fillOpacity:1.3})
            ];

            // Custom Legend Control with toggle button
            const LegendControl = L.Control.extend({
                options: { position: 'bottomright' },
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'legend');
                    const toggleBtn = L.DomUtil.create('button', 'legend-toggle', container);
                    toggleBtn.innerHTML = '▼ Legend';  // Initial state: shown
                    const content = L.DomUtil.create('div', 'legend-content', container);
                    layerData.forEach((data, index) => {
                        const item = L.DomUtil.create('div', 'legend-item', content);
                        item.innerHTML = `
<img src="${layerLogos[index]}" class="legend-logo" alt="${data.name} logo">
<div class="legend-swatch" style="background-color: ${data.color};"></div>
<div class="legend-text"><strong>${data.name}</strong>: ${data.desc}</div>
`;
                    });
                    // Add click event to toggle
                    L.DomEvent.on(toggleBtn, 'click', () => {
                        if (content.classList.contains('hidden')) {
                            content.classList.remove('hidden');
                            toggleBtn.innerHTML = '▼ Legend';
                        } else {
                            content.classList.add('hidden');
                            toggleBtn.innerHTML = '▶ Legend';
                        }
                    });
                    return container;
                }
            });
            // Wait for all layers to load, then add the controls
            Promise.all(layerPromises).then(() => {
                // Add a single combined layer control for base layers and overlays
                L.control.layers(baseLayers, overlays, { position: 'topright' }).addTo(map);
                // Add custom legend
                map.addControl(new LegendControl());
                // Add custom header panel
                map.addControl(new HeaderPanelControl());
                // Optional: Add some layers by default (e.g., Layer 1 and Layer 2)
                overlays['Layer 1: Points of interest in the city'].addTo(map);
                overlays['Layer 2: River boundaries and waterways'].addTo(map);
            });

            // Function to get buffer color and class based on RainfallLandslidethresholdwarninglevel
            function getBufferStyle(warningLevel) {
                if (warningLevel === 1) return { color: 'yellow', fillColor: 'yellow', className: 'flash-yellow' };
                if (warningLevel === 2) return { color: 'orange', fillColor: 'orange', className: 'flash-orange' };
                if (warningLevel === 3) return { color: 'red', fillColor: 'red', className: 'flash-red' };
                return { color: 'transparent', fillColor: 'transparent', className: '' }; // For "down" or any other value
            }

            // Function to fetch forecast data (using OpenWeatherMap API - replace with your API key)
            async function getForecast(lat, lng) {
                const apiKey = '6100dbfc0c41b1930339945d65813963'; // Replace with your actual API key
                const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lng}&appid=${apiKey}&units=metric`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.cod !== '200') throw new Error('Forecast data not available');
                    // Extract next 5 days forecast (assuming 3-hour intervals, take one per day)
                    let forecastHtml = '<h4>5-Day Weather Forecast</h4><table class="popup-table"><tr><th>Date</th><th>Temp (°C)</th><th>Description</th><th>Rain (mm)</th></tr>';
                    const dailyForecasts = {};
                    data.list.forEach(item => {
                        const date = new Date(item.dt * 1000).toDateString();
                        if (!dailyForecasts[date]) {
                            dailyForecasts[date] = {
                                temp: item.main.temp,
                                desc: item.weather[0].description,
                                rain: item.rain ? item.rain['3h'] || 0 : 0
                            };
                        }
                    });
                    Object.keys(dailyForecasts).slice(0, 5).forEach(date => {
                        const f = dailyForecasts[date];
                        forecastHtml += `<tr><td>${date}</td><td>${f.temp}</td><td>${f.desc}</td><td>${f.rain}</td></tr>`;
                    });
                    forecastHtml += '</table>';
                    return forecastHtml;
                } catch (error) {
                    console.error('Error fetching forecast:', error);
                    return '<p>Forecast data unavailable. Please try again later.</p>';
                }
            }

            // Add click event to pin location and show forecast
            map.on('click', async function(e) {
                const lat = e.latlng.lat.toFixed(6);
                const lng = e.latlng.lng.toFixed(6);
                const forecastData = await getForecast(lat, lng);
                const popupContent = `
<div class="popup-content">
<h3>Pinned Location</h3>
<p><strong>Latitude:</strong> ${lat}</p>
<p><strong>Longitude:</strong> ${lng}</p>
${forecastData}
            </div>
`;
                L.popup()
                    .setLatLng(e.latlng)
                    .setContent(popupContent)
                    .openOn(map);
            });

            // Fetch data from Sheetlabs API (replace with your actual API endpoint)
            // Example endpoint: https://sheetlabs.com/API/YOUR_SHEET_ID (you need to provide the real one)
            fetch('https://sheetlabs.com/LA25/LIGTASAGADEWSV3') // Replace with actual Sheetlabs API URL
                .then(response => response.json())
                .then(data => {
                data.forEach(station => {
                    var lat = parseFloat(station.Latitude);
                    var lng = parseFloat(station.Longitude);
                    var warningLevel = parseInt(station.RainfallLandslidethresholdwarninglevel);
                    var bufferStyle = getBufferStyle(warningLevel);

                    // Create a buffer circle around the station (radius set to 20 kilometers)
                    var bufferRadius = 20000; // Meters (20 km)
                    var circle = L.circle([lat, lng], {
                        color: bufferStyle.color,
                        fillColor: bufferStyle.fillColor,
                        fillOpacity: 0.3,
                        dashArray: 5.10,

                        radius: bufferRadius,
                        className: bufferStyle.className
                    }).addTo(map);

                    // Toggle button functionality
                    const toggleButton = document.getElementById('toggle-buffer');
                    let bufferVisible = true;

                    toggleButton.addEventListener('click', () => {
                        if (bufferVisible) {
                            map.removeLayer(circle);
                            toggleButton.textContent = 'Show 20-KM Warning';
                        } else {
                            map.addLayer(circle);
                            toggleButton.textContent = 'Hide 20-KM Warning';
                        }
                        bufferVisible = !bufferVisible;
                    });
                    // Create custom marker icon if 'Icon' is provided
                    var marker;
                    if (station.Icon) {
                        var customIcon = L.icon({
                            iconUrl: station.Icon,
                            iconSize: [25, 25], // Adjust size as needed
                            iconAnchor: [12, 25],
                            popupAnchor: [0, -25]
                        });
                        marker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
                    } else {
                        marker = L.marker([lat, lng]).addTo(map);
                    }

                    // Create popup content with a scrollable table
                    var popupContent = `
<div class="popup-content">
<h2>${station.StationName || station.Station}</h2>
<table class="popup-table">
<tr><th>Field</th><th>Value</th></tr>
<tr><td>Status</td><td>${station.Status}</td></tr>
<tr><td>Location Details</td><td>${station.LocationDetails}</td></tr>
<tr><td>Antecedent + Accumulated Rainfall ()</td><td>${station.Rainfall}</td></tr>
<tr><td>Warning Level</td><td>${station.RainfallLandslidethresholdwarninglevel}</td></tr>
<tr><td>Rainfall Description</td><td>${station.Rainfalldescription}</td></tr>
<tr><td>Possible Scenario</td><td>${station.Possiblescenario}</td></tr>
<tr><td>Recommended Actions</td><td>${station.Recommendedactions}</td></tr>
<tr><td>Warning Level Guide</td><td><img src="${station.Warninglevelguide}" alt="Warning Level Guide" /></td></tr>
<tr><td>Image Link</td><td><img src="${station.Imagelink}" alt="Image" /></td></tr>
<tr><td>Municipality and Barangay Covered</td><td>${station.Daterange}</td></tr>
            </table>
            </div>
`;

                    // Bind popup to both marker and circle
                    marker.bindPopup(popupContent);
                    circle.bindPopup(popupContent);
                });
            })
                .catch(error => {
                console.error('Error fetching data from API:', error);
                alert('Failed to load data from API. Check the console for details.');
            });

            // Add a custom reset view control
            L.Control.ResetView = L.Control.extend({
                onAdd: function(map) {
                    const container = L.DomUtil.create('div', 'leaflet-control-reset');
                    container.innerHTML = 'Reset View';
                    container.onclick = function() {
                        map.setView(initialCenter, initialZoom);
                    };
                    return container;
                }
            });

            L.control.resetView = function(opts) {
                return new L.Control.ResetView(opts);
            };

            L.control.resetView().addTo(map);

            // navigation buttons
            function Homebutton() {
                window.open('https://ligtas.uplb.edu.ph/', '_blank');
            }
            function AWSbutton() {
                window.open('https://ligtas.uplb.edu.ph/automatic-weather-station-monitoring/', '_blank');
            }

           
       const geojsonUrls = [
                
                //Group1 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day01_Bin1.geojson', // L1:
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day01_Bin2.geojson', // L2: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day01_Bin3.geojson', // L3: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day01_Bin4.geojson', // L4: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day01_Bin5.geojson', // L5: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day01_Bin6.geojson', // L6: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day01_Bin7.geojson',
                //Group2 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day02_Bin1.geojson', // L1:
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day02_Bin2.geojson', // L2: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day02_Bin3.geojson', // L3: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day02_Bin4.geojson', // L4: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day02_Bin5.geojson', // L5: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day02_Bin6.geojson', // L6: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day02_Bin7.geojson', // L7: 
                //Group3 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day03_Bin1.geojson', // L1:
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day03_Bin2.geojson', // L2: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day03_Bin3.geojson', // L3: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day03_Bin4.geojson', // L4: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day03_Bin5.geojson', // L5: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day03_Bin6.geojson', // L6: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day03_Bin7.geojson',  // L7:
                //Group4 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin1.geojson', // L1:
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin2.geojson', // L2: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin3.geojson', // L3: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin4.geojson', // L4: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin5.geojson', // L5: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin6.geojson', // L6: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin7.geojson',  // L7:
                //Group4 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin1.geojson', // L1:
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin2.geojson', // L2: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin3.geojson', // L3: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin4.geojson', // L4: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin5.geojson', // L5: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin6.geojson', // L6: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day04_Bin7.geojson',  // L7:
                //Group5 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day05_Bin1.geojson', // L1:
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day05_Bin2.geojson', // L2: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day05_Bin3.geojson', // L3: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day05_Bin4.geojson', // L4: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day05_Bin5.geojson', // L5: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day05_Bin6.geojson', // L6: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day05_Bin7.geojson',  // L7:
                //Group6 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day06_Bin1.geojson', // L1:
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day06_Bin2.geojson', // L2: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day06_Bin3.geojson', // L3: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day06_Bin4.geojson', // L4: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day06_Bin5.geojson', // L5: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day06_Bin6.geojson', // L6: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day06_Bin7.geojson',  // L7:
                //Group7 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day07_Bin1.geojson', // L1:
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day07_Bin2.geojson', // L2: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day07_Bin3.geojson', // L3: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day07_Bin4.geojson', // L4: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day07_Bin5.geojson', // L5: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day07_Bin6.geojson', // L6: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day07_Bin7.geojson',  // L7:
                //Group8 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin1.geojson', // L1:
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin2.geojson', // L2: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin3.geojson', // L3: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin4.geojson', // L4: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin5.geojson', // L5: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin6.geojson', // L6: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin7.geojson',  // L7:
                //Group9 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin1.geojson', // L1:
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin2.geojson', // L2: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin3.geojson', // L3: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin4.geojson', // L4: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin5.geojson', // L5: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin6.geojson', // L6: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin7.geojson',  // L7:
                //Group10
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin1.geojson', // L1:
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin2.geojson', // L2: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin3.geojson', // L3: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin4.geojson', // L4: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin5.geojson', // L5: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin6.geojson', // L6: 
                'https://raw.githubusercontent.com/Gabzrock/CRSS/refs/heads/main/Daily_RF_Day08_Bin7.geojson'  // L7:
            ];

            // Array of 21 unique colors for each layer
            const colors = [
                'violet', 'indigo', 'blue', 'green', 'yellow', 'orange', 'red',
                'violet', 'indigo', 'blue', 'green', 'yellow', 'orange', 'red',
                'violet', 'indigo', 'blue', 'green', 'yellow', 'orange', 'red',
                'violet', 'indigo', 'blue', 'green', 'yellow', 'orange', 'red',
                'violet', 'indigo', 'blue', 'green', 'yellow', 'orange', 'red',
                'violet', 'indigo', 'blue', 'green', 'yellow', 'orange', 'red',
                'violet', 'indigo', 'blue', 'green', 'yellow', 'orange', 'red',
                'violet', 'indigo', 'blue', 'green', 'yellow', 'orange', 'red',
                'violet', 'indigo', 'blue', 'green', 'yellow', 'orange', 'red',
                'violet', 'indigo', 'blue', 'green', 'yellow', 'orange', 'red'

            ];


        // Popup function (generic, shows properties if available)
        function onEachFeature(feature, layer) {
            const props = feature.properties;
            let popupContent = '<b>Layer Info</b><br>';
            for (const key in props) {
                popupContent += `${key}: ${props[key]}<br>`;
            }
            layer.bindPopup(popupContent);
        }

        // Load all GeoJSON data asynchronously with error handling
        const loadPromises = geojsonUrls.map((url, index) => 
            fetch(url).then(response => response.json()).catch(error => {
                console.error(`Failed to load GeoJSON for layer ${index + 1}:`, error);
                return null; // Return null for failed loads
            })
        );

        Promise.allSettled(loadPromises).then(results => {
            const geojsonData = results.map(result => result.status === 'fulfilled' ? result.value : null);
            const failedIndices = results.map((result, index) => result.status === 'rejected' ? index : -1).filter(i => i !== -1);

            if (failedIndices.length > 0) {
                document.getElementById('errorOverride').style.display = 'block';
                const errorList = document.getElementById('errorList');
                errorList.innerHTML = '<p>Failed layers: ' + failedIndices.map(i => `Layer ${i + 1}`).join(', ') + '</p>';
            }

            // Divide into 3 groups of 7 layers each
            const groups = [];
            for (let g = 0; g < 10; g++) {
                const group = [];
                for (let i = 0; i < 7; i++) {
                    const index = g * 7 + i;
                    const data = geojsonData[index];
                    if (data) {
                        const layer = L.geoJSON(data, {
                            style: {
                                color: colors[index],
                                weight: 1,
                                opacity: 0.7,
                                fillColor: colors[index],
                                fillOpacity: 0.8
                            },
                            onEachFeature: onEachFeature
                        });
                        group.push(layer);
                    } else {
                        group.push(null); // Placeholder for failed layers
                    }
                }
                groups.push(group);
            }

            // Initially display group 1 (index 0)
            let currentGroupIndex = 0;
            groups[currentGroupIndex].forEach(layer => {
                if (layer) map.addLayer(layer);
            });

            // Function to update layer controls
            function updateLayerControls() {
                const controlsDiv = document.getElementById('layerControls');
                // Clear existing checkboxes
                const existingCheckboxes = controlsDiv.querySelectorAll('input[type="checkbox"]');
                existingCheckboxes.forEach(cb => cb.parentNode.removeChild(cb));
                const existingLabels = controlsDiv.querySelectorAll('label');
                existingLabels.forEach(lb => lb.parentNode.removeChild(lb));
                const existingBrs = controlsDiv.querySelectorAll('br');
                existingBrs.forEach(br => br.parentNode.removeChild(br));

                groups[currentGroupIndex].forEach((layer, idx) => {
                    const globalIndex = currentGroupIndex * 7 + idx;
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `layer-${idx}`;
                    checkbox.checked = layer && map.hasLayer(layer);
                    checkbox.disabled = !layer; // Disable if layer failed to load
                    const label = document.createElement('label');
                    label.htmlFor = `layer-${idx}`;
                    label.textContent = `Layer ${idx + 1} (${colors[globalIndex]})` + (layer ? '' : ' (Failed to load)');
                    if (layer) {
                        checkbox.addEventListener('change', () => {
                            if (checkbox.checked) {
                                map.addLayer(layer);
                            } else {
                                map.removeLayer(layer);
                            }
                        });
                    }
                    controlsDiv.appendChild(checkbox);
                    controlsDiv.appendChild(label);
                    controlsDiv.appendChild(document.createElement('br'));
                });
            }

            // Function to update properties table
            function updatePropertiesTable() {
                const tableBody = document.getElementById('propertiesTableBody');
                tableBody.innerHTML = ''; // Clear existing rows
                groups[currentGroupIndex].forEach((layer, idx) => {
                    const globalIndex = currentGroupIndex * 7 + idx;
                    const data = geojsonData[globalIndex];
                    if (data && data.features && data.features.length > 0) {
                        const props = data.features[0].properties;
                        if (props) {
                            for (const key in props) {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>Layer ${idx + 1}</td>
                                    <td>${key}</td>
                                    <td>${props[key]}</td>
                                `;
                                tableBody.appendChild(row);
                            }
                        }
                    }
                });
            }

            // Update display function
            function updateDisplay() {
                // Remove all layers
                groups.forEach(group => group.forEach(layer => {
                    if (layer) map.removeLayer(layer);
                }));
                // Add current group
                groups[currentGroupIndex].forEach(layer => {
                    if (layer) map.addLayer(layer);
                });
                document.getElementById('currentGroup').textContent = `Current Group: ${currentGroupIndex + 1}`;
                updateLayerControls();
                updatePropertiesTable();
            }

            // Initial controls and table
            updateLayerControls();
            updatePropertiesTable();

            // Play/Pause/Stop functionality
            let intervalId = null;
            let isPlaying = false;
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            const speedSlider = document.getElementById('speedSlider');
            const speedValue = document.getElementById('speedValue');

            // Update speed display
            speedSlider.addEventListener('input', () => {
                speedValue.textContent = speedSlider.value;
            });

            playBtn.addEventListener('click', () => {
                if (isPlaying) return; // Already playing
                isPlaying = true;
                intervalId = setInterval(() => {
                    currentGroupIndex = (currentGroupIndex + 1) % 10;
                    updateDisplay();
                }, speedSlider.value * 200); // Use slider value in seconds
            });

            pauseBtn.addEventListener('click', () => {
                if (intervalId) {
                    clearInterval(intervalId);
                    intervalId = null;
                    isPlaying = false;
                }
            });

            stopBtn.addEventListener('click', () => {
                if (intervalId) {
                    clearInterval(intervalId);
                    intervalId = null;
                }
                isPlaying = false;
                currentGroupIndex = 0; // Reset to group 1
                updateDisplay();
            });

            // Remove All and Add All buttons
            const removeAllBtn = document.getElementById('removeAllBtn');
            const addAllBtn = document.getElementById('addAllBtn');

            removeAllBtn.addEventListener('click', () => {
                groups[currentGroupIndex].forEach(layer => {
                    if (layer) map.removeLayer(layer);
                });
                updateLayerControls(); // Update checkboxes to reflect removal
            });

            addAllBtn.addEventListener('click', () => {
                groups[currentGroupIndex].forEach(layer => {
                    if (layer) map.addLayer(layer);
                });
                updateLayerControls(); // Update checkboxes to reflect addition
            });

            // Override and Retry buttons
            const overrideBtn = document.getElementById('overrideBtn');
            const retryBtn = document.getElementById('retryBtn');

            overrideBtn.addEventListener('click', () => {
                document.getElementById('errorOverride').style.display = 'none';
                // Continue with loaded layers
            });

            retryBtn.addEventListener('click', () => {
                // Retry failed loads
                const retryPromises = failedIndices.map(index => 
                    fetch(geojsonUrls[index]).then(response => response.json()).catch(() => null)
                );
                Promise.allSettled(retryPromises).then(retryResults => {
                    retryResults.forEach((result, i) => {
                        const index = failedIndices[i];
                        if (result.status === 'fulfilled') {
                            geojsonData[index] = result.value;
                            // Update group
                            const g = Math.floor(index / 7);
                            const i = index % 7;
                            const data = geojsonData[index];
                            const layer = L.geoJSON(data, {
                                style: {
                                    color: colors[index],
                                    weight: 1,
                                    fillColor: colors[index],
                                    fillOpacity:0.8
                                },
                                onEachFeature: onEachFeature
                            });
                            groups[g][i] = layer;
                        }
                    });
                    document.getElementById('errorOverride').style.display = 'none';
                    updateDisplay(); // Refresh to include retried layers
                });
            });
        });

        // Note: Changed to Promise.allSettled to handle partial failures. Added error override section with buttons to continue or retry failed loads. Failed layers are marked in controls and skipped in display.
        </script>
    </body>
</html>
